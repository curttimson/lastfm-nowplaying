angular.module("lastfm-nowplaying",[]).directive("lastfmnowplaying",["uiCreation","lastFmAPI","lastFmParser",function(t,e,a){return{scope:{config:"=config"},link:function(n,r,i){e.getLatestScrobbles(n.config).then(function(e){var i=a.getLatestTrack(e);angular.forEach(r,function(e,a){angular.element(r).addClass("lastfm-nowplaying"),t.create(e,n,i)})})}}}]).factory("uiCreation",["$q","canvasUI",function(t,e){var a=function(a,n,r){var i=document.createElement("canvas");a.appendChild(i);var o=t.defer();return e.applyUI(a,i,r,function(){setTimeout(function(){var t=e.getAverageCanvasColor(i),a=!1;.299*t.r+.587*t.g+.114*t.b>186&&(a=!0),o.resolve({useBlackText:a})},200)}),o.promise},n=function(t,e){var a=document.createElement("div");angular.element(a).attr("style","background-image:url("+e+");").addClass("artwork"),t.appendChild(a)},r=function(t,e,a){var n=document.createElement("h3");angular.element(n).text("Now Playing");var r=document.createElement("p");angular.element(r).addClass("track").text(e.title);var i=document.createElement("p");angular.element(i).addClass("artist").text(e.artist);var o=document.createElement("div");angular.element(o).addClass("text"),angular.element(o).toggleClass("black",a),o.appendChild(n),o.appendChild(r),o.appendChild(i),t.appendChild(o)};return{create:function(t,e,i){a(t,e,i.xLargeImgUrl).then(function(a){var o=document.createElement("div");e.config.containerClass&&angular.element(o).addClass(e.config.containerClass),n(o,i.largeImgUrl),r(o,i,a.useBlackText),t.appendChild(o)})}}}]).factory("lastFmAPI",["$q","$http",function(t,e){return{getLatestScrobbles:function(a){var n="http://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user="+a.user+"&api_key="+a.apiKey+"&format=json&limit=2",r=t.defer();return e.get(n).then(function(t){r.resolve(t)}),r.promise}}}]).factory("lastFmParser",[function(){return{getLatestTrack:function(t){var e=t.data.recenttracks.track[0];return console.log("latestTrack",e),{title:e.name,artist:e.artist["#text"],largeImgUrl:e.image[2]["#text"],xLargeImgUrl:e.image[3]["#text"]}}}}]).factory("canvasUI",["imageFx",function(t){return{applyUI:function(e,a,n,r){t.blur($(e),a,6,n,function(){r()})},getAverageCanvasColor:function(t){for(var e=t.width,a=t.height,n=t.getContext("2d").getImageData(0,0,e,a).data,r=0,i=0,o=0,l=0,c=n.length;l<c;l+=4)r+=n[l],i+=n[l+1],o+=n[l+2];return r=Math.floor(r/(n.length/4)),i=Math.floor(i/(n.length/4)),o=Math.floor(o/(n.length/4)),{r:r,g:i,b:o}}}}]).factory("imageFx",["$window","$timeout",function(t,e){var a=function(t,e){this.image=e,this.element=t,this.element.width=this.image.width,this.element.height=this.image.height,this.context=this.element.getContext("2d"),this.context.drawImage(this.image,0,0)};a.prototype={blur:function(t){this.context.globalAlpha=.5;for(var e=-t;e<=t;e+=2)for(var a=-t;a<=t;a+=2)this.context.drawImage(this.element,a,e),a>=0&&e>=0&&this.context.drawImage(this.element,-(a-1),-(e-1));this.context.globalAlpha=1}};var n=function(t,e,a){var n=0,r=0;a.width/a.height>t.width()/t.height?(e.height(t.height()),e.width(e.height()*(a.width/a.height)),n=t.width()-e.width()):(e.width(t.outerWidth()),e.height(e.width()*(a.height/a.width))),r=(e.outerHeight()-t.outerHeight())/2*-1,e.css({marginLeft:n,marginTop:r})},r=function(e,r,i,o,l){var c,s;(c=document.createElement("img")).crossOrigin="Anonymous",c.onload=function(){(s=new a(r,this)).blur(i),n($(e),$(r),c),l&&l()},c.src=o,angular.element(t).bind("resize",function(){n($(e),$(r),c)})};return{blur:function(e,a,n,i,o){return!!!!t.HTMLCanvasElement&&r(e,a,n,i,o)}}}]);