angular.module("lastfm-nowplaying",[]).directive("lastfmnowplaying",["uiCreation","lastFmAPI","lastFmParser",function(t,e,n){return{scope:{config:"=config"},link:function(a,r,i){a.$watch("config",function(t){o()});var o=function(){e.getLatestScrobbles(a.config).then(function(e){var i=n.getLatestTrack(e);angular.forEach(r,function(e,n){angular.element(r).addClass("lastfm-nowplaying"),t.create(e,a,i)})},function(t){})}}}}]).factory("uiCreation",["$q","canvasUI",function(t,e){var n=function(n,a,r){n.innerHTML="";var i=document.createElement("canvas");n.appendChild(i);var o=t.defer();return e.applyUI(n,i,r,function(){setTimeout(function(){var t=e.getAverageCanvasColor(i),n=!1;.299*t.r+.587*t.g+.114*t.b>186&&(n=!0),o.resolve({useBlackText:n})},200)}),o.promise},a=function(t,e){var n=document.createElement("div");angular.element(n).attr("style","background-image:url("+e+");").addClass("artwork"),t.appendChild(n)},r=function(t,e,n){var a=document.createElement("h3");angular.element(a).text("Listening To");var r=document.createElement("p");angular.element(r).addClass("track").text(e.title);var i=document.createElement("p");angular.element(i).addClass("artist").text(e.artist);var o=document.createElement("div");angular.element(o).addClass("text"),angular.element(o).toggleClass("black",n),o.appendChild(a),o.appendChild(r),o.appendChild(i),t.appendChild(o)};return{create:function(t,e,i){n(t,e,i.xLargeImgUrl).then(function(n){angular.element(t).find("div").remove();var o=document.createElement("div");e.config.containerClass&&angular.element(o).addClass(e.config.containerClass),a(o,i.largeImgUrl),r(o,i,n.useBlackText),t.appendChild(o)})}}}]).factory("lastFmAPI",["$q","$http",function(t,e){return{getLatestScrobbles:function(n){var a=t.defer();if(n&&n.user&&n.apiKey){var r="http://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user="+n.user+"&api_key="+n.apiKey+"&format=json&limit=2";e.get(r).then(function(t){a.resolve(t)})}else a.reject("user or apiKey missing");return a.promise}}}]).factory("lastFmParser",[function(){return{getLatestTrack:function(t){var e=t.data.recenttracks.track[0];return{title:e.name,artist:e.artist["#text"],largeImgUrl:e.image[2]["#text"],xLargeImgUrl:e.image[3]["#text"]}}}}]).factory("canvasUI",["imageFx",function(t){return{applyUI:function(e,n,a,r){t.blur($(e),n,6,a,function(){r()})},getAverageCanvasColor:function(t){for(var e=t.width,n=t.height,a=t.getContext("2d").getImageData(0,0,e,n).data,r=0,i=0,o=0,l=0,c=a.length;l<c;l+=4)r+=a[l],i+=a[l+1],o+=a[l+2];return r=Math.floor(r/(a.length/4)),i=Math.floor(i/(a.length/4)),o=Math.floor(o/(a.length/4)),{r:r,g:i,b:o}}}}]).factory("imageFx",["$window","$timeout",function(t,e){var n=function(t,e){this.image=e,this.element=t,this.element.width=this.image.width,this.element.height=this.image.height,this.context=this.element.getContext("2d"),this.context.drawImage(this.image,0,0)};n.prototype={blur:function(t){this.context.globalAlpha=.5;for(var e=-t;e<=t;e+=2)for(var n=-t;n<=t;n+=2)this.context.drawImage(this.element,n,e),n>=0&&e>=0&&this.context.drawImage(this.element,-(n-1),-(e-1));this.context.globalAlpha=1}};var a=function(t,e,n){var a=0,r=0;n.width/n.height>t.width()/t.height?(e.height(t.height()),e.width(e.height()*(n.width/n.height)),a=t.width()-e.width()):(e.width(t.outerWidth()),e.height(e.width()*(n.height/n.width))),r=(e.outerHeight()-t.outerHeight())/2*-1,e.css({marginLeft:a,marginTop:r})},r=function(e,r,i,o,l){var c,s;(c=document.createElement("img")).crossOrigin="Anonymous",c.onload=function(){(s=new n(r,this)).blur(i),a($(e),$(r),c),l&&l()},c.src=o,angular.element(t).bind("resize",function(){a($(e),$(r),c)})};return{blur:function(e,n,a,i,o){return!!!!t.HTMLCanvasElement&&r(e,n,a,i,o)}}}]);