angular.module("lastfm-nowplaying",[]).directive("lastfmnowplaying",["uiCreation","lastFmAPI","lastFmParser",function(t,e,n){return{scope:{config:"=config"},link:function(a,r,i){a.$watch("config",function(t){l()});var l=function(){e.getLatestScrobbles(a.config).then(function(e){var i=n.getLatestTrack(e);angular.forEach(r,function(e,n){angular.element(r).addClass("lastfm-nowplaying"),t.create(e,a,i)})},function(t){})}}}}]).factory("uiCreation",["$q","canvasUI",function(t,e){var n=function(n,a,r){n.innerHTML="";var i=document.createElement("canvas");n.appendChild(i);var l=t.defer();return e.applyUI(n,i,r,function(){setTimeout(function(){var t=e.getAverageCanvasColor(i),n=!1;.299*t.r+.587*t.g+.114*t.b>186&&(n=!0),l.resolve({useBlackText:n})},200)}),l.promise},a=function(t,e){var n=document.createElement("div");angular.element(n).attr("style","background-image:url("+e+");").addClass("artwork"),t.appendChild(n)},r=function(t,e,n){var a=document.createElement("h3");angular.element(a).text("Listening To");var r=document.createElement("p");angular.element(r).addClass("track").text(e.title);var i=document.createElement("p");angular.element(i).addClass("artist").text(e.artist);var l=document.createElement("div");angular.element(l).addClass("text"),angular.element(l).toggleClass("black",n),l.appendChild(a),l.appendChild(r),l.appendChild(i),t.appendChild(l)};return{create:function(t,e,i){n(t,e,i.xLargeImgUrl).then(function(n){angular.element(t).find("div").remove();var l=document.createElement("div");e.config.containerClass&&angular.element(l).addClass(e.config.containerClass),a(l,i.largeImgUrl),r(l,i,n.useBlackText),t.appendChild(l)})}}}]).factory("lastFmAPI",["$q","$http",function(t,e){return{getLatestScrobbles:function(n){var a=t.defer();if(n&&n.user&&n.apiKey){var r="http://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user="+n.user+"&api_key="+n.apiKey+"&format=json&limit=2";e.get(r).then(function(t){a.resolve(t)})}else a.reject("user or apiKey missing");return a.promise}}}]).factory("lastFmParser",[function(){return{getLatestTrack:function(t){var e=t.data.recenttracks.track[0];return{title:e.name,artist:e.artist["#text"],largeImgUrl:e.image[2]["#text"],xLargeImgUrl:e.image[3]["#text"]}}}}]).factory("canvasUI",["imageFx",function(t){return{applyUI:function(e,n,a,r){t.blur(e,n,6,a,function(){r()})},getAverageCanvasColor:function(t){for(var e=t.width,n=t.height,a=t.getContext("2d").getImageData(0,0,e,n).data,r=0,i=0,l=0,o=0,c=a.length;o<c;o+=4)r+=a[o],i+=a[o+1],l+=a[o+2];return r=Math.floor(r/(a.length/4)),i=Math.floor(i/(a.length/4)),l=Math.floor(l/(a.length/4)),{r:r,g:i,b:l}}}}]).factory("imageFx",["$window","$timeout",function(t,e){var n=function(t,e){this.image=e,this.element=t,this.element.width=this.image.width,this.element.height=this.image.height,this.context=this.element.getContext("2d"),this.context.drawImage(this.image,0,0)};n.prototype={blur:function(t){this.context.globalAlpha=.5;for(var e=-t;e<=t;e+=2)for(var n=-t;n<=t;n+=2)this.context.drawImage(this.element,n,e),n>=0&&e>=0&&this.context.drawImage(this.element,-(n-1),-(e-1));this.context.globalAlpha=1}};var a=function(t,e,n){var a=$(t),r=$(e),i=0,l=0;n.width/n.height>t.clientWidth/t.clientHeight?(e.style.height=t.clientHeight+"px",e.style.width=r.height()*(n.width/n.height)+"px",i=a.width()-r.width()):(e.style.width=t.clientWidth+"px",e.style.height=r.width()*(n.height/n.width)+"px"),l=(r.outerHeight()-t.clientHeight)/2*-1,r.css({marginLeft:i,marginTop:l})},r=function(e,r,i,l,o){var c,s,g=function(){a(e,r,c)};(c=document.createElement("img")).crossOrigin="Anonymous",c.onload=function(){(s=new n(r,this)).blur(i),g(),o&&o()},c.src=l,angular.element(t).bind("resize",function(){g()})};return{blur:function(e,n,a,i,l){return!!!!t.HTMLCanvasElement&&r(e,n,a,i,l)}}}]);